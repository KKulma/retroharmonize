---
title: "Harmonize Value Labels"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Harmonize Value Labels}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(retroharmonize)
```

harmonize_values solves the following problems:

1. When the variable is read in from SPSS, `survey1$trust` has no user defined missing values, but `survey2$trust` has. The two variables cannot be combined. We add harmonized missing values to the missing value range, even if they are not present among the observations.   

2. The labels are not matching in `survey1$trust` and `survey2$trust`. We harmonize the labels, and record their initial values for reproducibility.

3. The missing value range is not matching in `survey1$trust` and `survey2$trust`. We harmonize the missing values, and record their initial values for reproducibility.

4. There are unexpected labels present in the value or missing range.  They are taken out from the value range with a special code and marked with a special label.


## Scenario 1

All values are present, and only the missing values are recoded. 

```{r}
v1 <- labelled_spss_survey (
  c(1,0,1,9), 
  labels = c("yes" =1,
             "no" = 0,
             "inap" = 9),
  na_values = 9)

h1 <- harmonize_values(
  x = v1, 
  harmonize_labels = list(
    from = c("^yes", "^no", "^inap"), 
    to = c("trust", "not_trust", "inap"), 
    numeric_value = c(1,0,99999)), 
  id = "survey1")

str(h1)
```
* `survey1_original_values` may be used to restore the original coding.

* `survey1_labels_orig` may be used to restore the original labelling.

* `na_values` can re-define if a category should be treated as missing.

The `to_numeric` method (not yet written) converts the missing value range to `NA_real_`.

## Scenario 2

The original variable is of class `haven_labelled_spss`. It has an invalid missing value.

```{r}
v2 <- haven::labelled_spss (
  c(1,1,0,8), 
  labels = c("yes" = 1,
             "no"  = 0,
             "declined" = 8),
  na_values = 8)

h2 <- harmonize_values(
  v2, 
  harmonize_labels = list(
    from = c("^yes", "^no", "^inap"), 
    to = c("trust", "not_trust", "inap"), 
    numeric_value = c(1,0,99999)), 
  id = 'survey2' )
str(h2)
```

We apply the code `99901` for this value and label it as `invalid_label`. 

After modifying the user-defined missing value labels:

```{r}
h2b <- harmonize_values(
  v2, 
  harmonize_labels = list(
    from = c("^yes", "^no", "^decline"), 
    to = c("trust", "not_trust", "inap"), 
    numeric_value = c(1,0,99999)), 
  id = 'survey2' )

str(h2b)
```

## Scenario 3

The original vector is of class `haven_labelled`, therefore it has no defined missing value range. We want to remove `DK` from the value range to the missing range as `do_not_know`. The original vector has an uncoded element. Because we believe that in this vector all values should have a value label, we treat it as an invalid observation.

```{r}
var3 <- labelled::labelled(
  x = c(1,6,2,9,1,1,2), 
  labels = c("Tend to trust" = 1, 
             "Tend not to trust" = 2, 
             "DK" = 6))

h3 <- harmonize_values(
  x = var3, 
  harmonize_labels = list ( 
    from = c("^tend\\sto|^trust",
             "^tend\\snot|not\\strust", "^dk",
             "^inap"), 
    to = c("trust", 
           "not_trust", "do_not_know", 
           "inap"),
    numeric_value = c(1,0,99997, 99999)
  ), 
  id = "S3_")

str(h3)
```

## Base Types & Summary

* as factor:

```{r}
summary(as_factor(h3))
levels(as_factor(h3)) 
unique(as_factor(h3))
```
* as numeric:

```{r}
summary(as_numeric(h3))
unique(as_numeric(h3))
```

* as character:

```{r}
summary(as_character(h3))
unique(as_character(h3))
```