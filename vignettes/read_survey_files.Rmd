---
title: "Read Survey Files"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Read Survey Files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(knitr)
```

```{r setup}
library(retroharmonize)
```

```{r}
iris1 <- retroharmonize::read_spss(
  system.file("examples", "iris1.sav", package = "retroharmonize"), 
  id = 'iris1')

iris2 <- retroharmonize::read_spss(
  system.file("examples", "iris2.sav", package = "retroharmonize"), 
  id = 'iris2')
```

There are a number of differences in iris1 and iris2.

* Petal.Length and Petal.Width are identical with the well-known iris dataset, but Petal.Length has missing values, coded as 991 in iris1 and 992 in iris2.
* Petal.Width has a variable label PETAL WIDTH in iris2, but not in iris1
* Petal.Length has a variable label PETAL LENGTH 1 in iris1 and PETAL LENGTH 2 in iris2.
* Species have missing values labelled as unidentified or missing in iris1 and as UNKNOWN and INAP in iris2. 
* There numeric coding is different, too, i.e. there are different integers specifying setosa, versicolor and virginica in the same datasets. For example, versicolor is coded as species 2 in iris1 but as species 3 in iris2.
* There is a further file for chain-linking, iris3, which has again different coding and labelling problems in Petal.Length and Species.

```{r}
summary(iris1$Sepal.Length)
labelled::val_labels(iris1$Sepal.Length)

```

```{r}
summary(iris2$Sepal.Length)
labelled::val_labels(iris2$Sepal.Length)
```

## Binding

The `rbind()` method for the `haven_labelled` class will correctly bind all vectors that inherit labels, and it will harmonize the labelling to with the first data.frame. The missing values are correctly identified.

```{r}
iris <- rbind (iris1, iris2)
summary (iris)
```

```{r}
print(head(iris$Species))
```

```{r}
labelled::val_labels(iris$Species)
labelled::val_labels(iris1$Species)
labelled::val_labels(iris2$Species)
```
If we add read and add iris3, the labelling will be still consistent in `iris_all$Species` and `iris_all$Sepal.Length`.

```{r}
iris3 <- retroharmonize::read_spss(
  system.file("examples", "iris3.sav", package = "retroharmonize"), 
  id = 'iris3')
iris_all <- rbind (iris, iris3)
labelled::val_labels(iris_all$Species)
labelled::val_labels(iris_all$Sepal.Length)
```

The binding works as long as the structure is the same:
* The variable names are exactly the same in the data frames
* The class of each variables is exactly the same.
* Class labelled and double can be coerced, so it did not cause a problem that `iris2$Sepal.Width` had a variable label attribute, but `iris1$Sepal.Width` did not have it.

The chain-linking stops as soon as we have a type mismatch.

```{r, eval=FALSE}
iris4 <- iris3
iris4$Species <- as_factor(iris4$Species)

rbind (iris_all, iris4)
```
```{r}
message("Error: Can't convert <character> to <double>.")
```
## The Missing Values

```{r}
attr(iris$Species, "na_values")
attr(iris1$Species, "na_values")
labelled::na_values(iris$Species)
labelled::na_values(iris2$Species)
```