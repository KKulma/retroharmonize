---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# retroharmonize

<!-- badges: start -->
[![Project Status: Minimal or no implementation has been done yet, or the repository is only intended to be a limited example, demo, or proof-of-concept.](https://www.repostatus.org/badges/latest/concept.svg)](https://www.repostatus.org/#concept)
[![license](https://img.shields.io/badge/license-GPL--3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0.en.html)
[![CRAN_Status_Badge](https://www.r-pkg.org/badges/version/eurobarometer)](https://cran.r-project.org/package=eurobarometer)
[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.3937746.svg)](https://doi.org/10.5281/zenodo.3937746)
[![Follow author](https://img.shields.io/twitter/follow/antaldaniel.svg?style=social)](https://twitter.com/intent/follow?screen_name=antaldaniel)
[![Codecov test coverage](https://codecov.io/gh/antaldaniel/retroharmonize/branch/master/graph/badge.svg)](https://codecov.io/gh/antaldaniel/retroharmonize?branch=master)
[![Travis build status](https://travis-ci.com/antaldaniel/retroharmonize.svg?branch=master)](https://travis-ci.com/antaldaniel/retroharmonize)
<!-- badges: end -->

The goal of `retroharmonize` is to facilitate retrospective (ex-post) harmonization of data, particularly survey data, in a reproducible manner. The package provides tools for organizing the metadata, standardizing the coding of variables, variable names and value labels, including missing values, and for documenting all transformations, with the help of comprehensive s3 classes.

Currently being generalized from problems solved in the  [github.com/antaldaniel/eurobarometer]((https://github.com/antaldaniel/eurobarometer)) package ([doi](https://doi.org/10.5281/zenodo.3825700).)

You can download the manual in [PDF](retroharmonize_0.1.7.pdf).

## Installation

Soon you can install the released version of retroharmonize from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("retroharmonize")
```

The development version from [GitHub](https://github.com/) can be installed with:

``` r
# install.packages("devtools")
devtools::install_github("antaldaniel/retroharmonize")
```

## Retrospective data harmonization

The aim of `retroharmonize` is to help the reproducible retrospective (ex-post) harmonization of datasets that contain comparable variables coded in different ways. Ex-post data harmonization creates new research opportunities. For example, 


This means that not only the numeric codes, the labels and the missing range is harmonized, but the original coding is preserved as metadata attributes for documentation and validation purposes. See more in the article [Harmonize Value Labels](http://retroharmonize.satellitereport.com/articles/harmonize_labels.html).


## Classes for retrospective harmonization

The `labelled_spss_survey()` class is an extension of haven's [labelled_spss](https://haven.tidyverse.org/reference/labelled_spss.html) class. It not only preserves variable and value labels and the user-defined missing range, but also gives an identifier, for example, the filename, to the vector. See [Working With The labelled_spss_survey Class](http://retroharmonize.satellitereport.com/articles/labelled_spss_survey.html).

```{r}
library(retroharmonize)
eb <- read_rds ( 
  file = system.file(
    "examples", "ZA7576.rds", package = "retroharmonize"), 
  id = "Eurobarometer_91_5_subsample", 
  doi = "10.4232/1.13393"
  )
print(eb)
```


## Harmonize categorical variables and missing values

```{r binding}
library(retroharmonize)
library(haven)

h2 <- harmonize_values(
  eb$qa14_2,  
  harmonize_labels = list(
    from = c("^tend to", "^tend not", "dk", "^inap"), 
    to = c("trust", "not_trust", "do_not_know", "inap"), 
    numeric_values = c(1,0,99997,99999)
    ), 
  id = attr(eb, "id") )

h2
```

## Create a longitudinal table

```{r}
var1 <- labelled::labelled_spss(
  x = c(1,0,1,1,0,8,9), 
  labels = c("TRUST" = 1, 
             "NOT TRUST" = 0, 
             "DON'T KNOW" = 8, 
             "INAP. HERE" = 9), 
  na_values = c(8,9))

var2 <- labelled::labelled_spss(
  x = c(2,2,8,9,1,1 ), 
  labels = c("Tend to trust" = 1, 
             "Tend not to trust" = 2, 
             "DK" = 8, 
             "Inap" = 9), 
  na_values = c(8,9))


h1 <- harmonize_values (
  x = var1, 
  harmonize_label = "Do you trust the European Union?",
  harmonize_labels = list ( 
    from = c("^tend\\sto|^trust", "^tend\\snot|not\\strust", "^dk|^don", "^inap"), 
    to = c("trust", "not_trust", "do_not_know", "inap"),
    numeric_values = c(1,0,99997, 99999)), 
  na_values = c("do_not_know" = 99997,
                "inap" = 99999), 
  id = "survey1",

)

h2 <- harmonize_values (
  x = var2, 
  harmonize_label = "Do you trust the European Union?",
  harmonize_labels = list ( 
    from = c("^tend\\sto|^trust", "^tend\\snot|not\\strust", "^dk|^don", "^inap"), 
    to = c("trust", "not_trust", "do_not_know", "inap"),
    numeric_values = c(1,0,99997, 99999)), 
  na_values = c("do_not_know" = 99997,
                "inap" = 99999), 
  id = "survey2"
)

a <- tibble::tibble ( rowid = paste0("survey1", 1:length(h1)),
                      hvar = h1, 
                      w = runif(n = length(h1), 0,1))
b <- tibble::tibble ( rowid = paste0("survey2", 1:length(h2)),
                      hvar  = h2, 
                      w = runif(n = length(h2), 0,1))

dplyr::bind_rows(a,b)
```

See the [Case Study: Working With Afrobarometer](articles/afrobarometer.html) and [Case Study: Working With Eurobarometer](articles/eurobarometer.html) for a further automated workflow. 

## Code of Conduct

Please note that the `retroharmonize` project is released with a [Contributor Code of Conduct](https://contributor-covenant.org/version/2/0/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.